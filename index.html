<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Afinador de Viol√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Base layout */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px; /* keep space on small screens */
    }

    .app {
      background: rgba(0, 0, 0, 0.45);
      padding: 28px;
      border-radius: 14px;
      width: 100%;
      max-width: 480px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
      -webkit-backdrop-filter: blur(6px);
      backdrop-filter: blur(6px);
      overflow: hidden;
    }

    h1 {
      margin-bottom: 6px;
      font-size: 1.6rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    p { margin-top: 0; margin-bottom: 8px; }

    .freq {
      font-size: 1.8rem;
      margin: 12px 0;
      font-weight: bold;
      color: #3498db;
      word-break: break-word;
    }

    .note {
      font-size: 2.6rem;
      margin: 8px 0;
      font-weight: bold;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    .note-full-name {
      font-size: 1.05rem;
      margin-top: 6px;
      opacity: 0.95;
      color: #3498db;
      font-weight: 500;
    }

    .tuned-lamp {
      margin: 12px 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .lamp {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #7f8c8d;
      box-shadow: 0 0 0 rgba(0,0,0,0.2);
      transition: all 0.25s ease;
      border: 3px solid rgba(255,255,255,0.15);
      flex-shrink: 0;
    }

    .lamp.idle { background: #7f8c8d; box-shadow: 0 0 0 rgba(0,0,0,0.2); }
    .lamp.far { background: #e74c3c; box-shadow: 0 0 18px rgba(231, 76, 60, 0.6); }
    .lamp.near { background: #f1c40f; box-shadow: 0 0 18px rgba(241, 196, 15, 0.6); }
    .lamp.tuned { background: #2ecc71; box-shadow: 0 0 22px rgba(46, 204, 113, 0.8); transform: scale(1.08); }

    .lamp-label {
      font-size: 0.98rem;
      font-weight: 600;
      letter-spacing: 0.2px;
      opacity: 0.95;
    }

    .string-info {
      margin-top: 14px;
      padding: 10px;
      background: rgba(52, 152, 219, 0.07);
      border-radius: 8px;
      border-left: 4px solid #3498db;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.5;
      word-break: break-word;
    }

    .string-info-title { font-weight: bold; color: #3498db; margin-bottom: 6px; font-size: 0.98rem; }

    .status {
      margin-top: 12px;
      font-size: 1rem;
      padding: 10px;
      border-radius: 8px;
      font-weight: 500;
      min-height: 20px;
      transition: all 0.3s ease;
    }

    .ok { background: #2ecc71; color: #000; }
    .low { background: #f1c40f; color: #000; }
    .high { background: #e74c3c; color: #fff; }
    .very-low { background: #e67e22; color: #fff; }
    .very-high { background: #c0392b; color: #fff; }
    .close { background: #f39c12; color: #000; }
    .very-close { background: #27ae60; color: #000; }

    .tuning-indicator { margin: 14px 0; position: relative; min-height: 44px; display: flex; align-items: center; justify-content: center; }

    .tuning-bar-container {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 6px;
      position: relative;
      overflow: visible;
      margin: 12px 0;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.25);
    }

    .tuning-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #e74c3c, #f39c12, #f1c40f, #27ae60); border-radius: 6px; transition: width 0.3s ease, background 0.3s ease; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.25); }

    .tuning-bar::after { content: ''; position: absolute; right: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 20px; background: #fff; box-shadow: 0 0 12px rgba(255,255,255,0.9); border-radius: 2px; }

    .tuning-bar-container::before { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 3px; height: 26px; background: rgba(255, 255, 255, 0.6); box-shadow: 0 0 8px rgba(255,255,255,0.5); z-index: 1; border-radius: 2px; }

    .tuning-arrow { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.6rem; transition: all 0.3s ease; text-shadow: 0 0 8px currentColor; }
    .tuning-arrow.left { color: #e74c3c; }
    .tuning-arrow.right { color: #e74c3c; }
    .tuning-arrow.center { color: #2ecc71; font-size: 2rem; }

    .accuracy-text { margin-top: 8px; font-size: 0.9rem; opacity: 0.95; font-weight: 500; }

    .progress-info { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.85rem; opacity: 0.8; }

    .strings-container { margin-top: 18px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 18px; }

    .string-btn { padding: 14px 10px; font-size: 1.05rem; font-weight: bold; border-radius: 12px; border: 2px solid transparent; cursor: pointer; background: linear-gradient(135deg, #34495e, #2c3e50); color: #fff; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.2); text-align: center; }

    .string-btn:active, .string-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.25); }
    .string-btn.active { background: linear-gradient(135deg, #3498db, #2980b9); border-color: #fff; box-shadow: 0 0 18px rgba(52, 152, 219, 0.45); transform: scale(1.03); }
    .string-btn:disabled { background: #7f8c8d; cursor: not-allowed; opacity: 0.65; }

    .string-label { display: block; font-size: 0.75rem; opacity: 0.85; margin-top: 4px; line-height: 1.2; }

    .start-btn { margin-top: 14px; padding: 12px 22px; font-size: 1rem; font-weight: bold; border-radius: 12px; border: none; cursor: pointer; background: linear-gradient(135deg, #27ae60, #229954); color: #fff; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
    .start-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.25); }
    .start-btn:disabled { background: #7f8c8d; cursor: not-allowed; opacity: 0.6; }

    .info-text { margin-top: 12px; font-size: 0.88rem; opacity: 0.75; font-style: italic; }

    /* Responsive adjustments */
    @media (max-width: 720px) {
      .strings-container { grid-template-columns: repeat(2, 1fr); }
      .note { font-size: 2.2rem; }
      .freq { font-size: 1.6rem; }
      .tuning-arrow { font-size: 1.5rem; }
    }

    @media (max-width: 420px) {
      .app { padding: 18px; border-radius: 12px; }
      .strings-container { grid-template-columns: 1fr; gap: 8px; }
      .note { font-size: 1.8rem; }
      .note-full-name { font-size: 0.98rem; }
      .freq { font-size: 1.2rem; }
      .lamp { width: 36px; height: 36px; }
      .tuning-bar-container { height: 8px; }
      .tuning-bar::after { height: 18px; }
      .tuning-arrow.center { font-size: 1.6rem; }
      .start-btn { width: 100%; padding: 12px; }
      .string-btn { padding: 12px; font-size: 1rem; }
    }

    /* Accessibility: larger touch targets on small devices */
    @media (hover: none) and (pointer: coarse) {
      .string-btn { padding: 16px; font-size: 1.05rem; }
      .start-btn { padding: 14px; font-size: 1.05rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>üé∏ Afinador de Viol√£o</h1>
    <p>Selecione uma corda e use o microfone para afinar</p>

    <div class="strings-container" id="stringsContainer"></div>

    <div class="freq" id="frequency">-- Hz</div>
    <div class="note" id="note">--</div>
    <div class="note-full-name" id="noteFullName"></div>

    <div class="tuned-lamp">
      <div class="lamp idle" id="tunedLamp"></div>
      <div class="lamp-label" id="lampLabel">Aguardando</div>
    </div>
    
    <div class="string-info" id="stringInfo" style="display: none;">
      <div class="string-info-title">‚ÑπÔ∏è Informa√ß√µes da Corda</div>
      <div class="string-info-item" id="stringInfoContent"></div>
    </div>
    
    <div class="tuning-indicator" id="tuningIndicator" style="display: none;">
      <div class="tuning-arrow" id="tuningArrow">‚Üí</div>
    </div>
    
    <div class="tuning-bar-container">
      <div class="tuning-bar" id="tuningBar"></div>
    </div>
    
    <div class="accuracy-text" id="accuracyText"></div>
    <div class="progress-info">
      <span>Muito Baixo</span>
      <span id="targetFreq">-- Hz</span>
      <span>Muito Alto</span>
    </div>
    
    <div class="status" id="status">Selecione uma corda para come√ßar</div>

    <button class="start-btn" id="startBtn">Iniciar Afinador</button>

    <div class="info-text">
      Clique em uma corda acima para afinar
    </div>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const frequencyEl = document.getElementById('frequency');
    const noteEl = document.getElementById('note');
    const noteFullNameEl = document.getElementById('noteFullName');
    const statusEl = document.getElementById('status');
    const stringsContainer = document.getElementById('stringsContainer');
    const tuningIndicator = document.getElementById('tuningIndicator');
    const tuningArrow = document.getElementById('tuningArrow');
    const tuningBar = document.getElementById('tuningBar');
    const accuracyText = document.getElementById('accuracyText');
    const targetFreq = document.getElementById('targetFreq');
    const stringInfo = document.getElementById('stringInfo');
    const stringInfoContent = document.getElementById('stringInfoContent');
    const tunedLamp = document.getElementById('tunedLamp');
    const lampLabel = document.getElementById('lampLabel');

    let audioContext;
    let analyser;
    let buffer;
    let selectedString = null;
    let lastFrequency = null;
    let freqHistory = [];
    let currentState = 'idle';
    let stateCounter = 0;
    const MAX_HISTORY = 8; // suaviza leitura
    const REQUIRED_STABLE_FRAMES = 4; // evita piscar

    const NOTES = [
      { 
        note: 'E', 
        fullName: 'Mi', 
        freq: 82.41, 
        label: 'Mi (6¬™)',
        position: '6¬™ corda (mais grossa)',
        octave: 'Mi2',
        description: 'A corda mais grave do viol√£o, tamb√©m conhecida como 6¬™ corda'
      },
      { 
        note: 'A', 
        fullName: 'L√°', 
        freq: 110.0, 
        label: 'L√° (5¬™)',
        position: '5¬™ corda',
        octave: 'L√°2',
        description: 'Segunda corda mais grave, quinta corda do viol√£o'
      },
      { 
        note: 'D', 
        fullName: 'R√©', 
        freq: 146.83, 
        label: 'R√© (4¬™)',
        position: '4¬™ corda',
        octave: 'R√©3',
        description: 'Corda intermedi√°ria, quarta corda do viol√£o'
      },
      { 
        note: 'G', 
        fullName: 'Sol', 
        freq: 196.0, 
        label: 'Sol (3¬™)',
        position: '3¬™ corda',
        octave: 'Sol3',
        description: 'Terceira corda, uma das mais usadas em acordes'
      },
      { 
        note: 'B', 
        fullName: 'Si', 
        freq: 246.94, 
        label: 'Si (2¬™)',
        position: '2¬™ corda',
        octave: 'Si3',
        description: 'Segunda corda mais aguda, pen√∫ltima corda'
      },
      { 
        note: 'E', 
        fullName: 'Mi', 
        freq: 329.63, 
        label: 'Mi (1¬™)',
        position: '1¬™ corda (mais fina)',
        octave: 'Mi4',
        description: 'A corda mais aguda do viol√£o, tamb√©m conhecida como 1¬™ corda'
      }
    ];

    function setLamp(state, text) {
      tunedLamp.className = 'lamp ' + state;
      lampLabel.textContent = text;
    }

    function addToHistory(value) {
      if (value === -1) return;
      freqHistory.push(value);
      if (freqHistory.length > MAX_HISTORY) freqHistory.shift();
    }

    function smoothedFreq() {
      if (!freqHistory.length) return -1;
      const sum = freqHistory.reduce((a, b) => a + b, 0);
      return sum / freqHistory.length;
    }

    // Criar bot√µes para cada corda
    NOTES.forEach((note, index) => {
      const btn = document.createElement('button');
      btn.className = 'string-btn';
      btn.id = `string-${index}`;
      btn.innerHTML = `
        <span style="font-size: 1.3rem;">${note.note}</span>
        <span class="string-label">${note.fullName} (${note.position})</span>
      `;
      btn.addEventListener('click', () => selectString(index));
      stringsContainer.appendChild(btn);
    });

    function selectString(index) {
      // Remove active de todos os bot√µes
      document.querySelectorAll('.string-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Adiciona active ao bot√£o selecionado
      const selectedBtn = document.getElementById(`string-${index}`);
      selectedBtn.classList.add('active');
      
      selectedString = NOTES[index];
      noteEl.textContent = selectedString.note;
      noteFullNameEl.textContent = selectedString.fullName + ' - ' + selectedString.position;
      targetFreq.textContent = selectedString.freq.toFixed(2) + ' Hz';
      
      // Exibir informa√ß√µes da corda
      stringInfoContent.innerHTML = `
        <strong>Nota:</strong> ${selectedString.fullName} (${selectedString.note})<br>
        <strong>Frequ√™ncia alvo:</strong> ${selectedString.freq.toFixed(2)} Hz<br>
        <strong>Posi√ß√£o:</strong> ${selectedString.position}<br>
        <strong>Oitava:</strong> ${selectedString.octave}<br>
        <strong>Descri√ß√£o:</strong> ${selectedString.description}
      `;
      stringInfo.style.display = 'block';
      
      statusEl.textContent = 'Pronto para afinar';
      statusEl.className = 'status';
      tuningBar.style.width = '0%';
      accuracyText.textContent = '';
      tuningIndicator.style.display = 'none';
      setLamp('idle', 'Pronto');
      lastFrequency = null;
    }

    startBtn.addEventListener('click', async () => {
      if (!selectedString) {
        statusEl.textContent = 'Por favor, selecione uma corda primeiro';
        statusEl.className = 'status high';
        return;
      }

      startBtn.disabled = true;
      startBtn.textContent = 'Afinador Ativo';

      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(stream);

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;

        buffer = new Float32Array(analyser.fftSize);

        source.connect(analyser);
        detectPitch();
      } catch (error) {
        statusEl.textContent = 'Erro ao acessar o microfone';
        statusEl.className = 'status high';
        startBtn.disabled = false;
        startBtn.textContent = 'Iniciar Afinador';
      }
    });

    function detectPitch() {
      analyser.getFloatTimeDomainData(buffer);
      const frequency = autoCorrelate(buffer, audioContext.sampleRate);
      addToHistory(frequency);
      const smoothFrequency = smoothedFreq();

      if (smoothFrequency !== -1 && selectedString) {
        frequencyEl.textContent = smoothFrequency.toFixed(2) + ' Hz';
        noteEl.textContent = selectedString.note;
        noteFullNameEl.textContent = selectedString.fullName + ' - ' + selectedString.position;
        tuningIndicator.style.display = 'flex';

        const targetFreq = selectedString.freq;
        const diff = smoothFrequency - targetFreq;
        const diffPercent = (diff / targetFreq) * 100;
        const cents = Math.round(1200 * Math.log2(smoothFrequency / targetFreq));
        const absCents = Math.abs(cents);

        // Calcular precis√£o (0-100%)
        // Consideramos afinado quando est√° dentro de 5 cents
        const maxCents = 100; // M√°ximo de cents para considerar (ajust√°vel)
        const accuracy = Math.max(0, Math.min(100, 100 - (absCents / maxCents) * 100));
        
        // Atualizar barra de progresso
        tuningBar.style.width = accuracy + '%';
        
        // Atualizar cor da barra baseado na precis√£o
        if (accuracy >= 90) {
          tuningBar.style.background = '#2ecc71';
        } else if (accuracy >= 70) {
          tuningBar.style.background = '#27ae60';
        } else if (accuracy >= 50) {
          tuningBar.style.background = '#f1c40f';
        } else if (accuracy >= 30) {
          tuningBar.style.background = '#f39c12';
        } else {
          tuningBar.style.background = '#e74c3c';
        }

        // Atualizar seta indicadora
        tuningArrow.className = 'tuning-arrow';
        if (absCents < 5) {
          tuningArrow.textContent = '‚úì';
          tuningArrow.className = 'tuning-arrow center';
        } else if (diff < 0) {
          tuningArrow.textContent = '‚Üê';
          tuningArrow.className = 'tuning-arrow left';
        } else {
          tuningArrow.textContent = '‚Üí';
          tuningArrow.className = 'tuning-arrow right';
        }

        // Atualizar l√¢mpada de afinado
        const newState = absCents < 5 ? 'tuned' : absCents < 15 ? 'near' : 'far';
        const stateText = newState === 'tuned'
          ? 'Afinado'
          : newState === 'near'
            ? 'Quase l√°'
            : diff < 0 ? 'Aumente' : 'Diminua';

        if (newState !== currentState) {
          stateCounter += 1;
          if (stateCounter >= REQUIRED_STABLE_FRAMES) {
            currentState = newState;
            stateCounter = 0;
            setLamp(currentState, stateText);
          }
        } else {
          stateCounter = 0;
          setLamp(currentState, stateText);
        }

        // Atualizar texto de precis√£o
        if (absCents < 5) {
          accuracyText.textContent = `‚úì Perfeito! (${absCents} cents)`;
          accuracyText.style.color = '#2ecc71';
        } else if (absCents < 10) {
          accuracyText.textContent = `Muito pr√≥ximo! (${absCents} cents) - Continue ajustando`;
          accuracyText.style.color = '#27ae60';
        } else if (absCents < 20) {
          accuracyText.textContent = `Pr√≥ximo (${absCents} cents) - Voc√™ est√° no caminho certo!`;
          accuracyText.style.color = '#f1c40f';
        } else if (absCents < 30) {
          accuracyText.textContent = `Aproximando (${absCents} cents) - Continue ajustando`;
          accuracyText.style.color = '#f39c12';
        } else {
          accuracyText.textContent = `Longe (${absCents} cents) - Ajuste mais`;
          accuracyText.style.color = '#e74c3c';
        }

        // Verificar se est√° melhorando
        let improvingText = '';
        if (lastFrequency !== null) {
          const lastDiff = Math.abs(lastFrequency - targetFreq);
          const currentDiff = Math.abs(smoothFrequency - targetFreq);
          if (currentDiff < lastDiff) {
            improvingText = ' üìà Melhorando!';
          } else if (currentDiff > lastDiff) {
            improvingText = ' üìâ Afastando';
          }
        }
        lastFrequency = smoothFrequency;

        // Atualizar status com mensagens mais detalhadas
        if (absCents < 5) {
          statusEl.textContent = '‚úì‚úì‚úì PERFEITAMENTE AFINADO! ‚úì‚úì‚úì';
          statusEl.className = 'status ok';
        } else if (absCents < 10) {
          statusEl.textContent = `Quase l√°! (${absCents} cents)${improvingText}`;
          statusEl.className = 'status very-close';
        } else if (absCents < 20) {
          statusEl.textContent = `Bom progresso! (${absCents} cents)${improvingText}`;
          statusEl.className = 'status close';
        } else if (diff < 0) {
          if (absCents < 30) {
            statusEl.textContent = `Baixo (${absCents} cents) - Aumente um pouco${improvingText}`;
            statusEl.className = 'status low';
          } else {
            statusEl.textContent = `Muito baixo (${absCents} cents) - Aumente mais${improvingText}`;
            statusEl.className = 'status very-low';
          }
        } else {
          if (absCents < 30) {
            statusEl.textContent = `Alto (${absCents} cents) - Diminua um pouco${improvingText}`;
            statusEl.className = 'status high';
          } else {
            statusEl.textContent = `Muito alto (${absCents} cents) - Diminua mais${improvingText}`;
            statusEl.className = 'status very-high';
          }
        }
      } else if (selectedString) {
        statusEl.textContent = 'Aguardando som...';
        statusEl.className = 'status';
        tuningIndicator.style.display = 'none';
        tuningBar.style.width = '0%';
        accuracyText.textContent = '';
        setLamp('idle', 'Aguardando');
        lastFrequency = null;
        freqHistory = [];
      }

      requestAnimationFrame(detectPitch);
    }

    function getClosestString(freq) {
      return NOTES.reduce((prev, curr) =>
        Math.abs(curr.freq - freq) < Math.abs(prev.freq - freq) ? curr : prev
      );
    }

    function autoCorrelate(buffer, sampleRate) {
      let size = buffer.length;
      let rms = 0;

      for (let i = 0; i < size; i++) rms += buffer[i] * buffer[i];
      rms = Math.sqrt(rms / size);
      if (rms < 0.01) return -1;

      let r1 = 0, r2 = size - 1;
      const threshold = 0.2;

      for (let i = 0; i < size / 2; i++) {
        if (Math.abs(buffer[i]) < threshold) { r1 = i; break; }
      }

      for (let i = 1; i < size / 2; i++) {
        if (Math.abs(buffer[size - i]) < threshold) { r2 = size - i; break; }
      }

      buffer = buffer.slice(r1, r2);
      size = buffer.length;

      const c = new Array(size).fill(0);

      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size - i; j++) {
          c[i] += buffer[j] * buffer[j + i];
        }
      }

      let d = 0;
      while (c[d] > c[d + 1]) d++;

      let maxval = -1, maxpos = -1;
      for (let i = d; i < size; i++) {
        if (c[i] > maxval) {
          maxval = c[i];
          maxpos = i;
        }
      }

      return sampleRate / maxpos;
    }
  </script>
</body>
</html>
